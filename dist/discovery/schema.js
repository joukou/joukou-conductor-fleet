var DiscoverySchema, schemajs, _;

schemajs = require("schemajs");

_ = require("lodash");

DiscoverySchema = (function() {
  DiscoverySchema.prototype.id = "";

  DiscoverySchema.prototype.type = "";

  DiscoverySchema.prototype.properties = {};

  DiscoverySchema.prototype.schema = null;

  DiscoverySchema.prototype.schemaOptions = null;

  DiscoverySchema.prototype.client = null;


  /**
  * @param {string} id
  * @param {string} type
  * @param {Object} properties
   */

  function DiscoverySchema(id, type, properties, client) {
    this.id = id;
    this.type = type;
    this.properties = properties;
    this.client = client;
    if (!type) {
      throw new Error("Type is required");
    }
  }

  DiscoverySchema.prototype.validate = function(value) {
    var validation, values;
    if (value === null || value === void 0) {
      return {
        valid: false,
        value: value,
        reason: "Value is null or undefined",
        noValue: true
      };
    }
    if (this.type === "string" && typeof value !== "string") {
      value = JSON.stringify(value);
    }
    if (!DiscoverySchema.checkType(value, this.type)) {
      return {
        valid: false,
        value: value,
        reason: "Type of value isn't " + this.type
      };
    }
    if (this.type === "object") {
      validation = this._validateSchema(value);
      if (validation.valid) {
        return {
          valid: true,
          value: validation.data
        };
      } else {
        values = _.values(validation.errors);
        return {
          valid: false,
          value: value,
          reason: values[0]
        };
      }
    } else {
      return {
        valid: true,
        value: value
      };
    }
  };

  DiscoverySchema.checkType = function(value, type) {
    switch (type) {
      case "array":
        return _.isArray(value);
      case "object":
        return _.isPlainObject(value);
      case "string":
        return _.isString(value);
      case "integer":
        if (!_.isNumber(value)) {
          return false;
        }
        return value === parseInt(value);
      case "number":
        return _.isNumber(value);
      case "boolean":
        return _.isBoolean(value);
      case "any":
        return true;
      default:
        return false;
    }
  };

  DiscoverySchema.prototype._validateSchema = function(value) {
    this._generateSchema();
    return this.schema.validate(value);
  };

  DiscoverySchema.prototype._generateSchema = function() {
    if (!schemajs.types.any) {
      schemajs.types.any = function() {
        return true;
      };
    }
    return this.schema = this.schema || schemajs.create(this._generateSchemaOptions());
  };

  DiscoverySchema.prototype._generateSchemaOptions = function() {
    var key, options, property;
    if (this.schemaOptions) {
      return this.schemaOptions;
    }
    options = {};
    for (key in this.properties) {
      if (!this.properties.hasOwnProperty(key)) {
        continue;
      }
      property = this.properties[key];
      if (property.type === "array" || property.type === "object") {
        this._attachChildSchema(options, property, key);
      } else {
        options[key] = {
          type: this._correctType(property.type),
          required: !!property.required
        };
      }
    }
    return this.schemaOptions = options;
  };

  DiscoverySchema.prototype._correctType = function(type) {
    if (type === "integer") {
      return "int";
    }
    return type;
  };

  DiscoverySchema.prototype._attachChildSchema = function(options, property, key) {
    var childSchema, ref;
    if (property.type !== "object" && property.type !== "array") {
      return;
    }
    options[key] = {
      type: property.type,
      required: !!property.required
    };
    ref = null;
    if (property.type === "array" && property.items instanceof Object) {
      ref = property.items.$ref;
    } else if (property.type === "object") {
      ref = property.$ref;
    }
    if (!ref) {
      return;
    }
    childSchema = this.client.getSchema(ref);
    if (!childSchema || childSchema === this) {
      return;
    }
    if (property.type === "object" && childSchema.type !== "object") {
      throw new Error("Child schema must be an object is property is an object");
    }
    if (childSchema.type === "object") {
      if (property.type === "object") {
        return options[key].schema = childSchema._generateSchemaOptions();
      } else {
        return options[key].schema = {
          schema: childSchema._generateSchemaOptions(),
          type: childSchema.type
        };
      }
    } else {
      return options[key].schema = {
        type: this._correctType(childSchema.type)
      };
    }
  };

  return DiscoverySchema;

})();

module.exports = DiscoverySchema;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRpc2NvdmVyeS9zY2hlbWEuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUEsNEJBQUE7O0FBQUEsUUFBQSxHQUFZLE9BQUEsQ0FBUSxVQUFSLENBQVosQ0FBQTs7QUFBQSxDQUNBLEdBQVksT0FBQSxDQUFRLFFBQVIsQ0FEWixDQUFBOztBQUFBO0FBSUUsNEJBQUEsRUFBQSxHQUFJLEVBQUosQ0FBQTs7QUFBQSw0QkFDQSxJQUFBLEdBQU0sRUFETixDQUFBOztBQUFBLDRCQUVBLFVBQUEsR0FBWSxFQUZaLENBQUE7O0FBQUEsNEJBR0EsTUFBQSxHQUFRLElBSFIsQ0FBQTs7QUFBQSw0QkFJQSxhQUFBLEdBQWUsSUFKZixDQUFBOztBQUFBLDRCQUtBLE1BQUEsR0FBUSxJQUxSLENBQUE7O0FBTUE7QUFBQTs7OztLQU5BOztBQVdhLEVBQUEseUJBQUMsRUFBRCxFQUFLLElBQUwsRUFBVyxVQUFYLEVBQXVCLE1BQXZCLEdBQUE7QUFDWCxJQUFBLElBQUksQ0FBQyxFQUFMLEdBQVUsRUFBVixDQUFBO0FBQUEsSUFDQSxJQUFJLENBQUMsSUFBTCxHQUFZLElBRFosQ0FBQTtBQUFBLElBRUEsSUFBSSxDQUFDLFVBQUwsR0FBa0IsVUFGbEIsQ0FBQTtBQUFBLElBR0EsSUFBSSxDQUFDLE1BQUwsR0FBYyxNQUhkLENBQUE7QUFJQSxJQUFBLElBQUcsQ0FBQSxJQUFIO0FBRUUsWUFBVSxJQUFBLEtBQUEsQ0FBTSxrQkFBTixDQUFWLENBRkY7S0FMVztFQUFBLENBWGI7O0FBQUEsNEJBbUJBLFFBQUEsR0FBVSxTQUFDLEtBQUQsR0FBQTtBQUNSLFFBQUEsa0JBQUE7QUFBQSxJQUFBLElBQUcsS0FBQSxLQUFTLElBQVQsSUFBaUIsS0FBQSxLQUFTLE1BQTdCO0FBQ0UsYUFBTztBQUFBLFFBQ0wsS0FBQSxFQUFPLEtBREY7QUFBQSxRQUVMLEtBQUEsRUFBTyxLQUZGO0FBQUEsUUFHTCxNQUFBLEVBQVEsNEJBSEg7QUFBQSxRQUlMLE9BQUEsRUFB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QSxFQUR4QjtPQUFBLE1BQUE7ZUFHRSxPQUFRLENBQUEsR0FBQSxDQUFJLENBQUMsTUFBYixHQUNFO0FBQUEsVUFBQSxNQUFBLEVBQVEsV0FBVyxDQUFDLHNCQUFaLENBQUEsQ0FBUjtBQUFBLFVBQ0EsSUFBQSxFQUFNLFdBQVcsQ0FBQyxJQURsQjtVQUpKO09BREY7S0FBQSxNQUFBO2FBUUUsT0FBUSxDQUFBLEdBQUEsQ0FBSSxDQUFDLE1BQWIsR0FBc0I7QUFBQSxRQUFBLElBQUEsRUFBTSxJQUFJLENBQUMsWUFBTCxDQUFrQixXQUFXLENBQUMsSUFBOUIsQ0FBTjtRQVJ4QjtLQXBCa0I7RUFBQSxDQTFHcEIsQ0FBQTs7eUJBQUE7O0lBSkYsQ0FBQTs7QUFBQSxNQTJJTSxDQUFDLE9BQVAsR0FBaUIsZUEzSWpCLENBQUEiLCJmaWxlIjoiZGlzY292ZXJ5L3NjaGVtYS5qcyIsInNvdXJjZVJvb3QiOiIvc291cmNlLyIsInNvdXJjZXNDb250ZW50IjpbInNjaGVtYWpzICA9IHJlcXVpcmUoXCJzY2hlbWFqc1wiKVxuXyAgICAgICAgID0gcmVxdWlyZShcImxvZGFzaFwiKVxuXG5jbGFzcyBEaXNjb3ZlcnlTY2hlbWFcbiAgaWQ6IFwiXCJcbiAgdHlwZTogXCJcIlxuICBwcm9wZXJ0aWVzOiB7fVxuICBzY2hlbWE6IG51bGxcbiAgc2NoZW1hT3B0aW9uczogbnVsbFxuICBjbGllbnQ6IG51bGxcbiAgIyMjKlxuICAqIEBwYXJhbSB7c3RyaW5nfSBpZFxuICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlXG4gICogQHBhcmFtIHtPYmplY3R9IHByb3BlcnRpZXNcbiAgIyMjXG4gIGNvbnN0cnVjdG9yOiAoaWQsIHR5cGUsIHByb3BlcnRpZXMsIGNsaWVudCkgLT5cbiAgICB0aGlzLmlkID0gaWRcbiAgICB0aGlzLnR5cGUgPSB0eXBlXG4gICAgdGhpcy5wcm9wZXJ0aWVzID0gcHJvcGVydGllc1xuICAgIHRoaXMuY2xpZW50ID0gY2xpZW50XG4gICAgaWYgbm90IHR5cGVcbiAgICAgICMgV2UgdXNlIHR5cGUgZm9yIHZhbGlkYXRpb25cbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlR5cGUgaXMgcmVxdWlyZWRcIilcbiAgdmFsaWRhdGU6ICh2YWx1ZSkgLT5cbiAgICBpZiB2YWx1ZSBpcyBudWxsIG9yIHZhbHVlIGlzIHVuZGVmaW5lZFxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdmFsaWQ6IGZhbHNlXG4gICAgICAgIHZhbHVlOiB2YWx1ZVxuICAgICAgICByZWFzb246IFwiVmFsdWUgaXMgbnVsbCBvciB1bmRlZmluZWRcIlxuICAgICAgICBub1ZhbHVlOiB0cnVlXG4gICAgICB9XG4gICAgaWYgdGhpcy50eXBlIGlzIFwic3RyaW5nXCIgYW5kIHR5cGVvZiB2YWx1ZSBpc250IFwic3RyaW5nXCJcbiAgICAgIHZhbHVlID0gSlNPTi5zdHJpbmdpZnkodmFsdWUpXG4gICAgaWYgbm90IERpc2NvdmVyeVNjaGVtYS5jaGVja1R5cGUodmFsdWUsIHRoaXMudHlwZSlcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHZhbGlkOiBmYWxzZVxuICAgICAgICB2YWx1ZTogdmFsdWVcbiAgICAgICAgcmVhc29uOiBcIlR5cGUgb2YgdmFsdWUgaXNuJ3QgI3t0aGlzLnR5cGV9XCJcbiAgICAgIH1cbiAgICBpZiB0aGlzLnR5cGUgaXMgXCJvYmplY3RcIlxuICAgICAgdmFsaWRhdGlvbiA9IHRoaXMuX3ZhbGlkYXRlU2NoZW1hKHZhbHVlKVxuICAgICAgaWYgdmFsaWRhdGlvbi52YWxpZFxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHZhbGlkOiB0cnVlXG4gICAgICAgICAgdmFsdWU6IHZhbGlkYXRpb24uZGF0YVxuICAgICAgICB9XG4gICAgICBlbHNlXG4gICAgICAgIHZhbHVlcyA9IF8udmFsdWVzKHZhbGlkYXRpb24uZXJyb3JzKVxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHZhbGlkOiBmYWxzZVxuICAgICAgICAgIHZhbHVlOiB2YWx1ZVxuICAgICAgICAgIHJlYXNvbjogdmFsdWVzWzBdXG4gICAgICAgIH1cbiAgICBlbHNlXG4gICAgICByZXR1cm4ge1xuICAgICAgICB2YWxpZDogdHJ1ZVxuICAgICAgICB2YWx1ZTogdmFsdWVcbiAgICAgIH1cbiAgQGNoZWNrVHlwZTogKHZhbHVlLCB0eXBlKSAtPlxuICAgICMgVmFsaWQgdHlwZXNcbiAgICAjIGh0dHA6Ly90b29scy5pZXRmLm9yZy9odG1sL2RyYWZ0LXp5cC1qc29uLXNjaGVtYS0wMyNzZWN0aW9uLTUuMVxuICAgIHN3aXRjaCB0eXBlXG4gICAgICB3aGVuIFwiYXJyYXlcIlxuICAgICAgICBfLmlzQXJyYXkoIHZhbHVlIClcbiAgICAgIHdoZW4gXCJvYmplY3RcIlxuICAgICAgICBfLmlzUGxhaW5PYmplY3QoIHZhbHVlIClcbiAgICAgIHdoZW4gXCJzdHJpbmdcIlxuICAgICAgICBfLmlzU3RyaW5nKCB2YWx1ZSApXG4gICAgICB3aGVuIFwiaW50ZWdlclwiXG4gICAgICAgIHJldHVybiBmYWxzZSBpZiBub3QgXy5pc051bWJlciggdmFsdWUgKVxuICAgICAgICB2YWx1ZSBpcyBwYXJzZUludCggdmFsdWUgKVxuICAgICAgd2hlbiBcIm51bWJlclwiXG4gICAgICAgIF8uaXNOdW1iZXIodmFsdWUpXG4gICAgICB3aGVuIFwiYm9vbGVhblwiXG4gICAgICAgIF8uaXNCb29sZWFuKHZhbHVlKVxuICAgICAgd2hlbiBcImFueVwiXG4gICAgICAgIHRydWVcbiAgICAgIGVsc2VcbiAgICAgICAgZmFsc2VcbiAgX3ZhbGlkYXRlU2NoZW1hOiAodmFsdWUpIC0+XG4gICAgdGhpcy5fZ2VuZXJhdGVTY2hlbWEoKVxuICAgIHJldHVybiB0aGlzLnNjaGVtYS52YWxpZGF0ZSh2YWx1ZSlcbiAgX2dlbmVyYXRlU2NoZW1hOiAtPlxuICAgIGlmIG5vdCBzY2hlbWFqcy50eXBlcy5hbnlcbiAgICAgIHNjaGVtYWpzLnR5cGVzLmFueSA9IC0+XG4gICAgICAgIHRydWVcbiAgICB0aGlzLnNjaGVtYSA9IHRoaXMuc2NoZW1hIG9yIHNjaGVtYWpzLmNyZWF0ZSh0aGlzLl9nZW5lcmF0ZVNjaGVtYU9wdGlvbnMoKSlcbiAgX2dlbmVyYXRlU2NoZW1hT3B0aW9uczogLT5cbiAgICBpZiB0aGlzLnNjaGVtYU9wdGlvbnNcbiAgICAgIHJldHVybiB0aGlzLnNjaGVtYU9wdGlvbnNcbiAgICBvcHRpb25zID0ge31cbiAgICBmb3Iga2V5IG9mIHRoaXMucHJvcGVydGllc1xuICAgICAgaWYgbm90IHRoaXMucHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShrZXkpXG4gICAgICAgIGNvbnRpbnVlXG4gICAgICBwcm9wZXJ0eSA9IHRoaXMucHJvcGVydGllc1trZXldXG4gICAgICBpZiBwcm9wZXJ0eS50eXBlIGlzIFwiYXJyYXlcIiBvciBwcm9wZXJ0eS50eXBlIGlzIFwib2JqZWN0XCJcbiAgICAgICAgdGhpcy5fYXR0YWNoQ2hpbGRTY2hlbWEob3B0aW9ucywgcHJvcGVydHksIGtleSlcbiAgICAgIGVsc2VcbiAgICAgICAgb3B0aW9uc1trZXldID0ge1xuICAgICAgICAgIHR5cGU6IHRoaXMuX2NvcnJlY3RUeXBlKHByb3BlcnR5LnR5cGUpLFxuICAgICAgICAgIHJlcXVpcmVkOiAhIXByb3BlcnR5LnJlcXVpcmVkXG4gICAgICAgIH1cbiAgICB0aGlzLnNjaGVtYU9wdGlvbnMgPSBvcHRpb25zXG4gIF9jb3JyZWN0VHlwZTogKHR5cGUpIC0+XG4gICAgIyBcImludGVnZXJcIiBpcyB0aGUgb25seSB0eXBlIHRoYXQgaXMgZGlmZmVyZW50XG4gICAgIyBodHRwczovL2dpdGh1Yi5jb20vZWxlaXRoL3NjaGVtYWpzI3NjaGVtYXR5cGVzXG4gICAgIyBJIGhhdmUgZXh0ZW5kZWQgc2NoZW1hIHRvIGFjY2VwdCB0eXBlIFwiYW55XCJcbiAgICBpZiB0eXBlIGlzIFwiaW50ZWdlclwiXG4gICAgICByZXR1cm4gXCJpbnRcIlxuICAgIHJldHVybiB0eXBlXG4gIF9hdHRhY2hDaGlsZFNjaGVtYTogKG9wdGlvbnMsIHByb3BlcnR5LCBrZXkpIC0+XG4gICAgaWYgcHJvcGVydHkudHlwZSBpc250IFwib2JqZWN0XCIgYW5kIHByb3BlcnR5LnR5cGUgaXNudCBcImFycmF5XCJcbiAgICAgIHJldHVyblxuICAgIG9wdGlvbnNba2V5XSA9IHtcbiAgICAgIHR5cGU6IHByb3BlcnR5LnR5cGUsXG4gICAgICByZXF1aXJlZDogISFwcm9wZXJ0eS5yZXF1aXJlZFxuICAgIH1cbiAgICByZWYgPSBudWxsXG4gICAgaWYgcHJvcGVydHkudHlwZSBpcyBcImFycmF5XCIgYW5kIHByb3BlcnR5Lml0ZW1zIGluc3RhbmNlb2YgT2JqZWN0XG4gICAgICByZWYgPSBwcm9wZXJ0eS5pdGVtcy4kcmVmXG4gICAgZWxzZSBpZiBwcm9wZXJ0eS50eXBlIGlzIFwib2JqZWN0XCJcbiAgICAgIHJlZiA9IHByb3BlcnR5LiRyZWZcbiAgICBpZiBub3QgcmVmXG4gICAgICByZXR1cm5cbiAgICBjaGlsZFNjaGVtYSA9IHRoaXMuY2xpZW50LmdldFNjaGVtYShyZWYpXG4gICAgIyBXZSBkb24ndCB3YW50IGNpcmN1bGFyIHJlZmVyZW5jZXNcbiAgICBpZiBub3QgY2hpbGRTY2hlbWEgb3IgY2hpbGRTY2hlbWEgaXMgdGhpc1xuICAgICAgcmV0dXJuXG4gICAgaWYgcHJvcGVydHkudHlwZSBpcyBcIm9iamVjdFwiIGFuZCBjaGlsZFNjaGVtYS50eXBlIGlzbnQgXCJvYmplY3RcIlxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2hpbGQgc2NoZW1hIG11c3QgYmUgYW4gb2JqZWN0IGlzIHByb3BlcnR5IGlzIGFuIG9iamVjdFwiKVxuICAgIGlmIGNoaWxkU2NoZW1hLnR5cGUgaXMgXCJvYmplY3RcIlxuICAgICAgaWYgcHJvcGVydHkudHlwZSBpcyBcIm9iamVjdFwiXG4gICAgICAgIG9wdGlvbnNba2V5XS5zY2hlbWEgPSBjaGlsZFNjaGVtYS5fZ2VuZXJhdGVTY2hlbWFPcHRpb25zKClcbiAgICAgIGVsc2UgIyBpZiBwcm9wZXJ0eS50eXBlIGlzIFwiYXJyYXlcIlxuICAgICAgICBvcHRpb25zW2tleV0uc2NoZW1hID1cbiAgICAgICAgICBzY2hlbWE6IGNoaWxkU2NoZW1hLl9nZW5lcmF0ZVNjaGVtYU9wdGlvbnMoKVxuICAgICAgICAgIHR5cGU6IGNoaWxkU2NoZW1hLnR5cGVcbiAgICBlbHNlXG4gICAgICBvcHRpb25zW2tleV0uc2NoZW1hID0gdHlwZTogdGhpcy5fY29ycmVjdFR5cGUoY2hpbGRTY2hlbWEudHlwZSlcbm1vZHVsZS5leHBvcnRzID0gRGlzY292ZXJ5U2NoZW1hIl19