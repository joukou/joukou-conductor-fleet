var DiscoveryMethod, DiscoverySchema, Q, request, _;

_ = require("lodash");

Q = require("q");

request = require("request");

DiscoverySchema = require("./schema");

DiscoveryMethod = (function() {
  DiscoveryMethod.prototype.id = "";

  DiscoveryMethod.prototype.description = "";

  DiscoveryMethod.prototype.httpMethod = "";

  DiscoveryMethod.prototype.path = "";

  DiscoveryMethod.prototype.parameters = {};

  DiscoveryMethod.prototype.parameterOrder = [];

  DiscoveryMethod.prototype.request = {};

  DiscoveryMethod.prototype.response = {};

  DiscoveryMethod.prototype.client = null;

  function DiscoveryMethod(id, description, httpMethod, path, parameters, parameterOrder, req, response, client) {
    this.id = id;
    this.description = description;
    this.httpMethod = httpMethod;
    this.path = path;
    this.parameters = parameters;
    this.parameterOrder = parameterOrder;
    this.request = req;
    this.response = response;
    this.client = client;
    if (!httpMethod || typeof httpMethod !== "string") {
      throw new Error("Http method not provided for " + id);
    } else {
      this.httpMethod = httpMethod.toUpperCase();
    }
    if (!path || typeof path !== "string") {
      throw new Error("Path not provided for " + id);
    }
  }


  /**
  @param {Object} params
  @returns {Promise}
   */

  DiscoveryMethod.prototype.callMethod = function(params, body) {
    var deferred, err;
    deferred = Q.defer();
    try {
      this._callMethod(params, body, deferred);
    } catch (_error) {
      err = _error;
      deferred.reject(err);
    }
    return deferred.promise;
  };

  DiscoveryMethod.prototype._callMethod = function(params, body, deferred) {
    params = params || {};
    if (!_.isPlainObject(params)) {
      throw new TypeError("Params is expected to be an Object");
    }
    params = this._groupValue(params);
    this._checkRequired(params);
    params = _.transform(params, function(result, value, key) {
      return result[key] = value.value;
    });
    return this._doRequest(params, this._getRequestBody(body), deferred);
  };

  DiscoveryMethod.prototype._getRequestBody = function(body) {
    var schema, validation;
    if (!_.isPlainObject(this.request) || !this.request.$ref) {
      return null;
    }
    if (!body || !_.isPlainObject(body)) {
      throw new Error("Request body is required");
    }
    schema = this.client.getSchema(this.request.$ref);
    if (!schema) {
      return body;
    }
    validation = schema.validate(body);
    if (validation.valid) {
      return validation.value;
    }
    throw new Error(validation.reason);
  };

  DiscoveryMethod.prototype._doRequest = function(params, requestBody, deferred, previousRequest) {
    var currentRequest, method;
    currentRequest = null;
    if (!previousRequest) {
      currentRequest = {
        url: "" + this.client.endpoint + this.client.basePath + this.path,
        json: requestBody,
        qs: params,
        method: this.httpMethod
      };
    } else {
      currentRequest = previousRequest;
    }
    method = this;
    return request(currentRequest, function(error, response, body) {
      return method._onResponse(error, response, body, deferred, currentRequest);
    });
  };

  DiscoveryMethod.prototype._onResponse = function(err, response, body, deferred, currentRequest) {
    var jsonBody;
    if (!err && (response.statusCode < 200 || response.statusCode >= 300)) {
      err = new Error("Status code returned " + response.statusCode);
    }
    if (err) {
      deferred.reject(err);
      return;
    }
    if (!body && this.httpMethod !== "GET") {
      deferred.resolve();
      return;
    } else if (!body) {
      deferred.reject(new Error("No body"));
      return;
    }
    jsonBody = null;
    try {
      jsonBody = JSON.parse(body);
    } catch (_error) {
      err = _error;
      deferred.reject(err);
      return;
    }
    if (this.response instanceof Object && this.response.$ref) {
      return this._resolveWithSchemaResponse(jsonBody, deferred, currentRequest);
    } else {
      return deferred.resolve(jsonBody);
    }
  };

  DiscoveryMethod.prototype._resolveWithSchemaResponse = function(jsonBody, deferred, currentRequest) {
    var childDeferred, key, schema, testKey, values;
    schema = this.client.getSchema(this.response.$ref);
    if (!schema) {
      return deferred.resolve(jsonBody);
    }
    if (!schema.properties["nextPageToken"]) {
      return deferred.resolve(jsonBody);
    }
    key = null;
    for (testKey in schema.properties) {
      if (!schema.properties.hasOwnProperty(testKey)) {
        continue;
      }
      if (testKey !== "nextPageToken") {
        key = testKey;
      }
    }
    if (!key) {
      return deferred.resolve(jsonBody);
    }
    if (schema.properties[key].type !== "array") {
      return deferred.resolve(jsonBody);
    }
    values = jsonBody[key];
    if (!_.isArray(values)) {
      return deferred.resolve(jsonBody);
    }
    if (!jsonBody["nextPageToken"]) {
      return deferred.resolve(values);
    }
    currentRequest.qs = currentRequest.qs || {};
    currentRequest.qs["nextPageToken"] = jsonBody["nextPageToken"];
    childDeferred = Q.defer();
    this._doRequest(null, null, childDeferred, currentRequest);
    return childDeferred.promise.then(function(childValues) {
      return deferred.resolve(values.concat(childValues));
    }).fail(function() {
      return deferred.resolve(values);
    });
  };

  DiscoveryMethod.prototype._groupValue = function(params) {
    return params = _.merge(this.parameters, params, function(a, b) {
      var exists, val, _i, _len, _ref;
      a = _.clone(a);
      if (!b) {
        return a;
      }
      if (a.type === "string" && typeof b !== "string") {
        b = b.toString();
      }
      if (DiscoverySchema.checkType(b, a.type)) {
        a.value = b;
      } else {
        if (typeof b === "string") {
          b = "'" + b + "'";
        }
        throw new TypeError("" + b + " is not typeof " + a.type);
      }
      a.value = b;
      if (a.type !== "string" || !_.isArray(a["enum"])) {
        return a;
      }
      exists = false;
      _ref = a["enum"];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        val = _ref[_i];
        if (val.toLowerCase() === a.value.toLowerCase()) {
          a.value = val;
          exists = true;
          break;
        }
      }
      if (!exists) {
        throw new Error("'" + a.value + "' is not one of '" + (a["enum"].join("', '")) + "'");
      }
      return a;
    });
  };

  DiscoveryMethod.prototype._checkRequired = function(params) {
    var key, val, _results;
    _results = [];
    for (key in params) {
      val = params[key];
      if (!val.required) {
        continue;
      }
      if (!val.value) {
        throw new Error("the parameter " + key + " is required");
      } else {
        _results.push(void 0);
      }
    }
    return _results;
  };

  return DiscoveryMethod;

})();

module.exports = DiscoveryMethod;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRpc2NvdmVyeS9tZXRob2QuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUEsK0NBQUE7O0FBQUEsQ0FBQSxHQUFrQixPQUFBLENBQVEsUUFBUixDQUFsQixDQUFBOztBQUFBLENBQ0EsR0FBa0IsT0FBQSxDQUFRLEdBQVIsQ0FEbEIsQ0FBQTs7QUFBQSxPQUVBLEdBQWtCLE9BQUEsQ0FBUSxTQUFSLENBRmxCLENBQUE7O0FBQUEsZUFHQSxHQUFrQixPQUFBLENBQVEsVUFBUixDQUhsQixDQUFBOztBQUFBO0FBTUUsNEJBQUEsRUFBQSxHQUFJLEVBQUosQ0FBQTs7QUFBQSw0QkFDQSxXQUFBLEdBQWEsRUFEYixDQUFBOztBQUFBLDRCQUVBLFVBQUEsR0FBWSxFQUZaLENBQUE7O0FBQUEsNEJBR0EsSUFBQSxHQUFNLEVBSE4sQ0FBQTs7QUFBQSw0QkFJQSxVQUFBLEdBQVksRUFKWixDQUFBOztBQUFBLDRCQUtBLGNBQUEsR0FBZ0IsRUFMaEIsQ0FBQTs7QUFBQSw0QkFNQSxPQUFBLEdBQVMsRUFOVCxDQUFBOztBQUFBLDRCQU9BLFFBQUEsR0FBVSxFQVBWLENBQUE7O0FBQUEsNEJBUUEsTUFBQSxHQUFRLElBUlIsQ0FBQTs7QUFTYSxFQUFBLHlCQUFDLEVBQUQsRUFDQyxXQURELEVBRUMsVUFGRCxFQUdDLElBSEQsRUFJQyxVQUpELEVBS0MsY0FMRCxFQU1DLEdBTkQsRUFPQyxRQVBELEVBUUMsTUFSRCxHQUFBO0FBU1gsSUFBQSxJQUFJLENBQUMsRUFBTCxHQUFVLEVBQVYsQ0FBQTtBQUFBLElBQ0EsSUFBSSxDQUFDLFdBQUwsR0FBbUIsV0FEbkIsQ0FBQTtBQUFBLElBRUEsSUFBSSxDQUFDLFVBQUwsR0FBa0IsVUFGbEIsQ0FBQTtBQUFBLElBR0EsSUFBSSxDQUFDLElBQUwsR0FBWSxJQUhaLENBQUE7QUFBQSxJQUlBLElBQUksQ0FBQyxVQUFMLEdBQWtCLFVBSmxCLENBQUE7QUFBQSxJQUtBLElBQUksQ0FBQyxjQUFMLEdBQXNC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QUFaLENBQUQsQ0FBN0IsR0FBa0QsR0FEM0MsQ0FBVixDQURGO09BdEJBO0FBMEJBLGFBQU8sQ0FBUCxDQTNCd0M7SUFBQSxDQUFqQyxFQURFO0VBQUEsQ0FySmIsQ0FBQTs7QUFBQSw0QkFtTEEsY0FBQSxHQUFnQixTQUFDLE1BQUQsR0FBQTtBQUNkLFFBQUEsa0JBQUE7QUFBQTtTQUFBLGFBQUEsR0FBQTtBQUNFLE1BQUEsR0FBQSxHQUFNLE1BQU8sQ0FBQSxHQUFBLENBQWIsQ0FBQTtBQUNBLE1BQUEsSUFBRyxDQUFBLEdBQU8sQ0FBQyxRQUFYO0FBQ0UsaUJBREY7T0FEQTtBQUdBLE1BQUEsSUFBRyxDQUFBLEdBQU8sQ0FBQyxLQUFYO0FBQ0UsY0FBVSxJQUFBLEtBQUEsQ0FBTyxnQkFBQSxHQUFnQixHQUFoQixHQUFvQixjQUEzQixDQUFWLENBREY7T0FBQSxNQUFBOzhCQUFBO09BSkY7QUFBQTtvQkFEYztFQUFBLENBbkxoQixDQUFBOzt5QkFBQTs7SUFORixDQUFBOztBQUFBLE1Ba01NLENBQUMsT0FBUCxHQUFpQixlQWxNakIsQ0FBQSIsImZpbGUiOiJkaXNjb3ZlcnkvbWV0aG9kLmpzIiwic291cmNlUm9vdCI6Ii9zb3VyY2UvIiwic291cmNlc0NvbnRlbnQiOlsiXyAgICAgICAgICAgICAgID0gcmVxdWlyZShcImxvZGFzaFwiKVxuUSAgICAgICAgICAgICAgID0gcmVxdWlyZShcInFcIilcbnJlcXVlc3QgICAgICAgICA9IHJlcXVpcmUoXCJyZXF1ZXN0XCIpXG5EaXNjb3ZlcnlTY2hlbWEgPSByZXF1aXJlKFwiLi9zY2hlbWFcIilcblxuY2xhc3MgRGlzY292ZXJ5TWV0aG9kXG4gIGlkOiBcIlwiXG4gIGRlc2NyaXB0aW9uOiBcIlwiXG4gIGh0dHBNZXRob2Q6IFwiXCJcbiAgcGF0aDogXCJcIlxuICBwYXJhbWV0ZXJzOiB7fVxuICBwYXJhbWV0ZXJPcmRlcjogW11cbiAgcmVxdWVzdDoge31cbiAgcmVzcG9uc2U6IHt9XG4gIGNsaWVudDogbnVsbFxuICBjb25zdHJ1Y3RvcjogKGlkLFxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgICAgICAgICAgIGh0dHBNZXRob2QsXG4gICAgICAgICAgICAgICAgcGF0aCxcbiAgICAgICAgICAgICAgICBwYXJhbWV0ZXJzLFxuICAgICAgICAgICAgICAgIHBhcmFtZXRlck9yZGVyLFxuICAgICAgICAgICAgICAgIHJlcSxcbiAgICAgICAgICAgICAgICByZXNwb25zZSxcbiAgICAgICAgICAgICAgICBjbGllbnQpIC0+XG4gICAgdGhpcy5pZCA9IGlkXG4gICAgdGhpcy5kZXNjcmlwdGlvbiA9IGRlc2NyaXB0aW9uXG4gICAgdGhpcy5odHRwTWV0aG9kID0gaHR0cE1ldGhvZFxuICAgIHRoaXMucGF0aCA9IHBhdGhcbiAgICB0aGlzLnBhcmFtZXRlcnMgPSBwYXJhbWV0ZXJzXG4gICAgdGhpcy5wYXJhbWV0ZXJPcmRlciA9IHBhcmFtZXRlck9yZGVyXG4gICAgdGhpcy5yZXF1ZXN0ID0gcmVxXG4gICAgdGhpcy5yZXNwb25zZSA9IHJlc3BvbnNlXG4gICAgdGhpcy5jbGllbnQgPSBjbGllbnRcbiAgICBpZiBub3QgaHR0cE1ldGhvZCBvciB0eXBlb2YgaHR0cE1ldGhvZCBpc250IFwic3RyaW5nXCJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkh0dHAgbWV0aG9kIG5vdCBwcm92aWRlZCBmb3IgI3tpZH1cIilcbiAgICBlbHNlXG4gICAgICB0aGlzLmh0dHBNZXRob2QgPSBodHRwTWV0aG9kLnRvVXBwZXJDYXNlKClcbiAgICBpZiBub3QgcGF0aCBvciB0eXBlb2YgcGF0aCBpc250IFwic3RyaW5nXCJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlBhdGggbm90IHByb3ZpZGVkIGZvciAje2lkfVwiKVxuICAjIyMqXG4gIEBwYXJhbSB7T2JqZWN0fSBwYXJhbXNcbiAgQHJldHVybnMge1Byb21pc2V9XG4gICMjI1xuICBjYWxsTWV0aG9kOiAocGFyYW1zLCBib2R5KSAtPlxuICAgIGRlZmVycmVkID0gUS5kZWZlcigpXG4gICAgdHJ5XG4gICAgICAjIFdyYXAgdGhlIHdob2xlIGZ1bmN0aW9uIG9yIGl0IGlzIGp1c3RcbiAgICAgICMgQmxvYXRlZCB3aXRoIHRyeSBjYXRjaGVzXG4gICAgICB0aGlzLl9jYWxsTWV0aG9kKHBhcmFtcywgYm9keSwgZGVmZXJyZWQpXG4gICAgY2F0Y2ggZXJyXG4gICAgICBkZWZlcnJlZC5yZWplY3QoZXJyKVxuICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlXG4gIF9jYWxsTWV0aG9kOiAocGFyYW1zLCBib2R5LCBkZWZlcnJlZCkgLT5cbiAgICBwYXJhbXMgPSBwYXJhbXMgb3Ige31cbiAgICBpZiBub3QgXy5pc1BsYWluT2JqZWN0KHBhcmFtcylcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJQYXJhbXMgaXMgZXhwZWN0ZWQgdG8gYmUgYW4gT2JqZWN0XCIpXG4gICAgcGFyYW1zID0gdGhpcy5fZ3JvdXBWYWx1ZShwYXJhbXMpXG4gICAgdGhpcy5fY2hlY2tSZXF1aXJlZChwYXJhbXMpXG4gICAgIyB0dXJuIHRoZSBxdWVyeSBzdHJpbmcgaW50byBrZXkgdmFsdWUgcGFpcnNcbiAgICBwYXJhbXMgPSBfLnRyYW5zZm9ybShwYXJhbXMsIChyZXN1bHQsIHZhbHVlLCBrZXkpIC0+XG4gICAgICByZXN1bHRba2V5XSA9IHZhbHVlLnZhbHVlXG4gICAgKVxuICAgIHRoaXMuX2RvUmVxdWVzdChwYXJhbXMsIHRoaXMuX2dldFJlcXVlc3RCb2R5KGJvZHkpLCBkZWZlcnJlZClcbiAgX2dldFJlcXVlc3RCb2R5OiAoYm9keSkgLT5cbiAgICBpZiBub3QgXy5pc1BsYWluT2JqZWN0KHRoaXMucmVxdWVzdCkgb3Igbm90IHRoaXMucmVxdWVzdC4kcmVmXG4gICAgICAjIFRPRE8gaW1wbGVtZW50IGZvciBub3QgJHJlZlxuICAgICAgIyBSZXF1ZXN0IGhhcyBubyBib2R5XG4gICAgICByZXR1cm4gbnVsbFxuICAgIGlmIG5vdCBib2R5IG9yIG5vdCBfLmlzUGxhaW5PYmplY3QoYm9keSlcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlJlcXVlc3QgYm9keSBpcyByZXF1aXJlZFwiKVxuICAgIHNjaGVtYSA9IHRoaXMuY2xpZW50LmdldFNjaGVtYSh0aGlzLnJlcXVlc3QuJHJlZilcbiAgICBpZiBub3Qgc2NoZW1hXG4gICAgICByZXR1cm4gYm9keVxuICAgIHZhbGlkYXRpb24gPSBzY2hlbWEudmFsaWRhdGUoYm9keSlcbiAgICBpZiB2YWxpZGF0aW9uLnZhbGlkXG4gICAgICByZXR1cm4gdmFsaWRhdGlvbi52YWx1ZVxuICAgIHRocm93IG5ldyBFcnJvcih2YWxpZGF0aW9uLnJlYXNvbilcbiAgX2RvUmVxdWVzdDogKHBhcmFtcywgcmVxdWVzdEJvZHksIGRlZmVycmVkLCBwcmV2aW91c1JlcXVlc3QpIC0+XG4gICAgY3VycmVudFJlcXVlc3QgPSBudWxsXG4gICAgaWYgbm90IHByZXZpb3VzUmVxdWVzdFxuICAgICAgY3VycmVudFJlcXVlc3QgPVxuICAgICAgICB1cmw6IFwiI3t0aGlzLmNsaWVudC5lbmRwb2ludH0je3RoaXMuY2xpZW50LmJhc2VQYXRofSN7dGhpcy5wYXRofVwiXG4gICAgICAgICMgV2lsbCBzZXQgY29udGVudC90eXBlIHRvIGFwcGxpY2F0aW9uL2pzb25cbiAgICAgICAganNvbjogcmVxdWVzdEJvZHlcbiAgICAgICAgcXM6IHBhcmFtc1xuICAgICAgICBtZXRob2Q6IHRoaXMuaHR0cE1ldGhvZFxuICAgIGVsc2VcbiAgICAgIGN1cnJlbnRSZXF1ZXN0ID0gcHJldmlvdXNSZXF1ZXN0XG4gICAgbWV0aG9kID0gdGhpc1xuICAgIHJlcXVlc3QoY3VycmVudFJlcXVlc3QsIChlcnJvciwgcmVzcG9uc2UsIGJvZHkpIC0+XG4gICAgICBtZXRob2QuX29uUmVzcG9uc2UoZXJyb3IsIHJlc3BvbnNlLCBib2R5LCBkZWZlcnJlZCwgY3VycmVudFJlcXVlc3QpXG4gICAgKVxuICBfb25SZXNwb25zZTogKGVyciwgcmVzcG9uc2UsIGJvZHksIGRlZmVycmVkLCBjdXJyZW50UmVxdWVzdCkgLT5cbiAgICBpZiBub3QgZXJyIGFuZCAocmVzcG9uc2Uuc3RhdHVzQ29kZSA8IDIwMCBvciByZXNwb25zZS5zdGF0dXNDb2RlID49IDMwMClcbiAgICAgICMgVE9ETyBJbXBsZW1lbnQgcmVkaXJlY3Rpb24gMzAxLCAzMDJbLCAzMDNdLCAzMDRcbiAgICAgIGVyciA9IG5ldyBFcnJvcihcIlN0YXR1cyBjb2RlIHJldHVybmVkICN7cmVzcG9uc2Uuc3RhdHVzQ29kZX1cIilcbiAgICBpZiBlcnJcbiAgICAgIGRlZmVycmVkLnJlamVjdChlcnIpXG4gICAgICByZXR1cm5cbiAgICBpZiBub3QgYm9keSBhbmQgdGhpcy5odHRwTWV0aG9kIGlzbnQgXCJHRVRcIlxuICAgICAgZGVmZXJyZWQucmVzb2x2ZSgpXG4gICAgICByZXR1cm5cbiAgICBlbHNlIGlmIG5vdCBib2R5XG4gICAgICBkZWZlcnJlZC5yZWplY3QobmV3IEVycm9yKFwiTm8gYm9keVwiKSlcbiAgICAgIHJldHVyblxuICAgIGpzb25Cb2R5ID0gbnVsbFxuICAgIHRyeVxuICAgICAganNvbkJvZHkgPSBKU09OLnBhcnNlKGJvZHkpXG4gICAgY2F0Y2ggZXJyXG4gICAgICBkZWZlcnJlZC5yZWplY3QoZXJyKVxuICAgICAgcmV0dXJuXG4gICAgaWYgdGhpcy5yZXNwb25zZSBpbnN0YW5jZW9mIE9iamVjdCBhbmQgdGhpcy5yZXNwb25zZS4kcmVmXG4gICAgICB0aGlzLl9yZXNvbHZlV2l0aFNjaGVtYVJlc3BvbnNlKGpzb25Cb2R5LCBkZWZlcnJlZCwgY3VycmVudFJlcXVlc3QpXG4gICAgZWxzZVxuICAgICAgZGVmZXJyZWQucmVzb2x2ZShqc29uQm9keSlcbiAgX3Jlc29sdmVXaXRoU2NoZW1hUmVzcG9uc2U6IChqc29uQm9keSwgZGVmZXJyZWQsIGN1cnJlbnRSZXF1ZXN0KSAtPlxuICAgIHNjaGVtYSA9IHRoaXMuY2xpZW50LmdldFNjaGVtYSh0aGlzLnJlc3BvbnNlLiRyZWYpXG4gICAgIyBObyBzY2hlbWEsIG5vIGNoZWNrXG4gICAgaWYgbm90IHNjaGVtYVxuICAgICAgcmV0dXJuIGRlZmVycmVkLnJlc29sdmUoanNvbkJvZHkpXG4gICAgIyBJZiByZXNwb25zZSBzaG91bGQgbmV2ZXIgY29udGFpbiBuZXh0UGFnZVRva2VuXG4gICAgaWYgbm90IHNjaGVtYS5wcm9wZXJ0aWVzW1wibmV4dFBhZ2VUb2tlblwiXVxuICAgICAgcmV0dXJuIGRlZmVycmVkLnJlc29sdmUoanNvbkJvZHkpXG4gICAgIyBUaGVyZSBzaG91bGQgYmUgb25lIG90aGVyIHByb3BlcnR5IG9mIHR5cGUgYXJyYXlcbiAgICBrZXkgPSBudWxsXG4gICAgZm9yIHRlc3RLZXkgb2Ygc2NoZW1hLnByb3BlcnRpZXNcbiAgICAgIGlmIG5vdCBzY2hlbWEucHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eSh0ZXN0S2V5KVxuICAgICAgICBjb250aW51ZVxuICAgICAgaWYgdGVzdEtleSBpc250IFwibmV4dFBhZ2VUb2tlblwiXG4gICAgICAgIGtleSA9IHRlc3RLZXlcbiAgICBpZiBub3Qga2V5XG4gICAgICByZXR1cm4gZGVmZXJyZWQucmVzb2x2ZShqc29uQm9keSlcbiAgICBpZiBzY2hlbWEucHJvcGVydGllc1trZXldLnR5cGUgaXNudCBcImFycmF5XCJcbiAgICAgICMgVE9ETyBpbXBsZW1lbnQgZm9yIG9iamVjdHNcbiAgICAgIHJldHVybiBkZWZlcnJlZC5yZXNvbHZlKGpzb25Cb2R5KVxuICAgICMgVGhpcyBzaG91bGQgYmUgYW4gYXJyYXlcbiAgICB2YWx1ZXMgPSBqc29uQm9keVtrZXldXG4gICAgIyBJZiBub3QgdGhyb3cgaXQgYXdheVxuICAgIGlmIG5vdCBfLmlzQXJyYXkodmFsdWVzKVxuICAgICAgcmV0dXJuIGRlZmVycmVkLnJlc29sdmUoanNvbkJvZHkpXG4gICAgaWYgbm90IGpzb25Cb2R5W1wibmV4dFBhZ2VUb2tlblwiXVxuICAgICAgIyBPbmx5IHJldHVybiB0byB0aGUgdXNlciB0aGUgdmFsdWVzXG4gICAgICByZXR1cm4gZGVmZXJyZWQucmVzb2x2ZSh2YWx1ZXMpXG4gICAgIyBNb2RpZnkgdGhlIGV4aXN0aW5nIHF1ZXJ5IHN0cmluZyBvciBjcmVhdGUgaXRcbiAgICBjdXJyZW50UmVxdWVzdC5xcyA9IGN1cnJlbnRSZXF1ZXN0LnFzIG9yIHt9XG4gICAgY3VycmVudFJlcXVlc3QucXNbXCJuZXh0UGFnZVRva2VuXCJdID0ganNvbkJvZHlbXCJuZXh0UGFnZVRva2VuXCJdXG4gICAgY2hpbGREZWZlcnJlZCA9IFEuZGVmZXIoKVxuICAgIHRoaXMuX2RvUmVxdWVzdChudWxsLCBudWxsLCBjaGlsZERlZmVycmVkLCBjdXJyZW50UmVxdWVzdClcbiAgICBjaGlsZERlZmVycmVkLnByb21pc2UudGhlbigoY2hpbGRWYWx1ZXMpIC0+XG4gICAgICBkZWZlcnJlZC5yZXNvbHZlKHZhbHVlcy5jb25jYXQoY2hpbGRWYWx1ZXMpKVxuICAgICkuZmFpbCggLT5cbiAgICAgICMgVE9ETyBkbyBzb21ldGhpbmcgaW4gdGhpcyBjYXNlIHdoZXJlIHRoZSBuZXh0IHBhZ2VcbiAgICAgICMgZmFpbHMsIGZvciBub3cgcmV0dXJuXG4gICAgICBkZWZlcnJlZC5yZXNvbHZlKHZhbHVlcylcbiAgICApXG4gIF9ncm91cFZhbHVlOiAocGFyYW1zKSAtPlxuICAgIHBhcmFtcyA9IF8ubWVyZ2UodGhpcy5wYXJhbWV0ZXJzLCBwYXJhbXMsIChhLCBiKSAtPlxuICAgICAgYSA9IF8uY2xvbmUoYSlcbiAgICAgIGlmIG5vdCBiXG4gICAgICAgIHJldHVybiBhXG4gICAgICBpZiBhLnR5cGUgaXMgXCJzdHJpbmdcIiBhbmQgdHlwZW9mIGIgaXNudCBcInN0cmluZ1wiXG4gICAgICAgIGIgPSBiLnRvU3RyaW5nKClcbiAgICAgIGlmIERpc2NvdmVyeVNjaGVtYS5jaGVja1R5cGUoYiwgYS50eXBlKVxuICAgICAgICBhLnZhbHVlID0gYlxuICAgICAgZWxzZVxuICAgICAgICBpZiB0eXBlb2YgYiBpcyBcInN0cmluZ1wiXG4gICAgICAgICAgYiA9IFwiJyN7Yn0nXCJcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIiN7Yn0gaXMgbm90IHR5cGVvZiAje2EudHlwZX1cIilcbiAgICAgIGEudmFsdWUgPSBiXG4gICAgICBpZiBhLnR5cGUgaXNudCBcInN0cmluZ1wiIG9yIG5vdCBfLmlzQXJyYXkoYS5lbnVtKVxuICAgICAgICByZXR1cm4gYVxuICAgICAgIyBXZSBoYXZlIGFuIGVudW0sIHJlc3RyaWN0IGEudmFsdWUgdG9cbiAgICAgICMgdGhlIHZhbHVlcyBpbiBlbnVtXG4gICAgICBleGlzdHMgPSBmYWxzZVxuICAgICAgZm9yIHZhbCBpbiBhLmVudW1cbiAgICAgICAgaWYgdmFsLnRvTG93ZXJDYXNlKCkgaXMgYS52YWx1ZS50b0xvd2VyQ2FzZSgpXG4gICAgICAgICAgYS52YWx1ZSA9IHZhbFxuICAgICAgICAgIGV4aXN0cyA9IHRydWVcbiAgICAgICAgICBicmVha1xuICAgICAgaWYgbm90IGV4aXN0c1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgXCInI3thLnZhbHVlfScgaXMgbm90IG9uZSBvZiAnI3thLmVudW0uam9pbihcIicsICdcIil9J1wiXG4gICAgICAgIClcbiAgICAgIHJldHVybiBhXG4gICAgKVxuICBfY2hlY2tSZXF1aXJlZDogKHBhcmFtcykgLT5cbiAgICBmb3Iga2V5IG9mIHBhcmFtc1xuICAgICAgdmFsID0gcGFyYW1zW2tleV1cbiAgICAgIGlmIG5vdCB2YWwucmVxdWlyZWRcbiAgICAgICAgY29udGludWVcbiAgICAgIGlmIG5vdCB2YWwudmFsdWVcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwidGhlIHBhcmFtZXRlciAje2tleX0gaXMgcmVxdWlyZWRcIilcblxuXG5tb2R1bGUuZXhwb3J0cyA9IERpc2NvdmVyeU1ldGhvZCJdfQ==